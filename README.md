# Automated Malware Scanner Validation Tool for Digital Forensics

This is a prototype of a malware scanner validation tool for digital forensics. It provides a framework to perform a couple of different tasks:
1. Creating a raw (dd) copy of a virtual machine drive through vboxmanage
2. Attaching the raw copied disk to the virtual machine
3. Uploading a malware executable and a startup script via SFTP to the virtual machine
4. Rebooting the virtual machine, starting Noriben, and executing the malware
5. Parsing the Noriben output and recovering files and registry entries that are reported by Noriben to exist on the infected disk
6. Executing malware scanners (currently F-Prot fpscan, ClamAV clamscan, and Sophos AV savscan) and parsing the output
7. The goal of the program is to provide objective data (using Noriben) to evaluate the suitability of the malware scanner to report forensically relevant artifacts.

Limitations
The prototype currently assumes the host computer is running Linux and the virtual machine is Windows configured to run SSH/SFTP. Additionally, this tool is not suitable for VM-aware malware and does not currently look for deleted artifacts.

## Getting Started

1. Install Virtualbox and the Virtualbox SDK on the host OS
2. Install Python modules Paramiko, python-registry, and virtualbox on the host OS
3. Setup a project directory (for example, /path/to/project), and install a suitable VM image for malware testing with a raw disk drive at /path/to/project/base/base.raw
4. Configure base virtual machine as follows
    1. Setup project directory (for example. C:\path\to\project)
    2. Install Python 3 (I used Python 3.7.3) and add the installation directory into the PATH environment variable.
    3. Install Noriben and ProcMon to C:\path\to\project\Noriben. Make sure to satisfy ProcMon’s clickthrough agreement
    4. Setup OpenSSH on the virtual machine
5. Obtain malware samples and place in /path/to/project/evidence
6. Configure host OS not to automount disks through file manager
7. Modify configuration file and point script to the configuration file

### The configuration file
Here is a sample configuration file and explanation of the parameters. Please delete the comment lines before using the configuration file.

<em> <strong>Path to project directory on host operating system. I put this on an external drive so as to avoid storing malware on my localhost. </em> </strong>  
project_path: /path/to/project  
<em> <strong>VM’s name in Virtualbox </em> </strong>  
vm_name: Base  
<em> <strong>Login information for VM </em> </strong>  
remote_username: TestUser  
remote_password: password  
<em> <strong>Only windows is currently implemented </em> </strong>  
remote_type: windows  
<em> <strong>SSH port for windows VM </em> </strong>  
remote_port: 22  
<em> <strong>SSH connection timeout </em> </strong>  
timeout_seconds: 360  
<em> <strong>Time before VM boots to login</em> </strong>  
boot_delay: 90  
<em> <strong>Time to await VM to obtain IP address </em> </strong>  
ip_delay: 20  
<em> <strong>Time to wait to let virus infect computer. Currently hardcoded </em> </strong>  
<em> <strong>NEEDS TO BE IMPLEMENTED</em> </strong>  
infect_delay: 60  
<em> <strong>Time to wait to let computer shutdown and let VM unlock </em> </strong>  
shutdown_delay: 60  
<em> <strong>Path where viruses are stored on host OS </em> </strong>  
virus_path: /path/to/project/evidence/  
<em> <strong>VM project directory </em> </strong>  
remote_path: c:\Path\To\Project  
<em> <strong>VM project directory – FTP style </em> </strong>  
remote_ftp_path: /c:/Path/To/Project  
<em> <strong>VM ip address </em> </strong>  
remote_ip: 192.168.51.50  
<em> <strong>%USERPROFILE%. Used to put script in Startup directory </em> </strong>  
remote_user: C:\Users\TestUser  
<em> <strong>%USERPROFILE%, %WINDIR%, %APPDATA%, and %LOCAL_APPDATA%. Note the extra slashes used for path delineation – this is used so the paths can be used with the Python regex module. Used to covert Noriben entries to paths that can be mapped to Linux-comprensible paths </em> </strong>  
remote_userprofile: C:\\Users\\TestUser  
remote_windir: C:\\Windows  
remote_appdata: C:\\Users\\TestUser\\Appdata  
remote_local_appdata: C:\\Users\\TestUser\\Local Settings\\Application Data  
<em> <strong>Used to compare the disk cloned by vboxmanage clonehd to the original disk </em> </strong>  
block_size: 512  
compare_offset: 206848  
<em> <strong>command line virus scanners, separated by a ', ' </em> </strong>  
<em> <strong>NEEDS TO BE IMPLEMENTED</em> </strong>  
virus_scanners: savscan,clamscan,fpscan  

### Prerequisites

Host OS software:
* Virtualbox
* Virtualbox SDK
* Python 3
* fpscan
* savscan
* clamscan

Host OS Python Modules:
* paramiko
* python-registry
* virtualbox

VM Software:
* Noriben
* Procmon
* OpenSSH


## Running the tool

There are two provided scripts that can use the tool to automate a testing suite.

generated_infected_vms.py:
Creates a clone of a raw vm disk image, then infects it using the specified infection protocol and the malware samples stored in /path/to/project/evidence. Runs Noriben on the VM to monitor the created artifacts.

evaluate_scanners.py:
Mounts raw vm disk images using udisksctl loop-setup and udisksctl mount, parses Noriben file, obtains copies of any still-existing artifacts, and executes virus scanners on the mounted raw vm disk image.

## System Setup

### Information about setting up the host OS

1. The most important factor in the success of your evaluation setup is the flavor / Linux distribution used for the host VM. The first version of the software used Lubuntu 18.04, which worked with a lot of difficulty. The latest version uses Kali 2020.2, which works fairly well without much difficulty. The main places you will encounter difficulty are getting python to communicate with the Virtualbox API and the installation of malware scanners. If you select a different Linux distribution and encounter trouble, it might be wise to choose a different distribution.
2. Install Virtualbox on your host OS. Here are a couple of ways you can install it.
3. You can find the Virtualbox SDK here. You can find instructions for installing the SDK here.
4. Install python3 on the host OS. You can use the command sudo apt-get install python3.8 or use the package manager, install from source, or whatever method you prefer. Kali 2020.2 comes with python3.8.
    1. Install pip (<strong>sudo apt-get install python3-pip</strong>) 
    2. Install the python modules using <strong>pip3 install virtualbox python-registry paramiko</strong>

### Detailed information about configuring the test VM

I found Windows 7 to be a good balance between modern features and malware vulnerability. I took the following steps to setup my local VM.

1. Install a vanilla Windows 7 installation in Virtualbox. If you haven’t done this before, you can follow this guide: Installing a Windows 7 VM in Virtualbox.
    1. You may find it helpful to install Guest Additions: Installing Guest Additions. This allows you to perform drag and drop from the host to the guest machine, create SMB shares, and other features that make it easier to setup the local VM. Note that malware can possibly check for the installation of Guest Additions (as well as use other methods to determine whether it is operating in a VM) and it may impact testing.
2. Install Windows 7 SP1. You can find SP1 here.
3. Additionally, I found it helpful to install KB303929, which is a fix to    a code signing issue that prevents the installation of Python and other important software. 
4. Some malware requires the .net framework to function. I installed the .net 4.0 30319 framework, which contains exploitable vulnerabilities.
5. Install Python 3 needed for Noriben. I installed Python 3.7.3. Make sure to check the box that installs Python to your path, or you will have to set it manually.
6. Create a project directory. I used <strong>C:\Users\TestUser\Documents\Project</strong>. Create a folder subfolder called Noriben and a subfolder called Malware. For example, <strong>C:\Users\TestUser\Documents\Project\Noriben</strong> and <strong>C:\Users\TestUser\Documents\Project\Malware</strong>. 
7. Download and unpack Noriben.zip from Github. You will need Process Monitor (ProcMon) to run Noriben. Download ProcMon, and place it in the Noriben directory. Make sure to run ProcMon and agree to the license agreement. You can run Noriben to make sure it functions correctly.
8. Install OpenSSH. You follow the instructions here, but you don’t need to worry about the firewall instructions (we will be disabling the firewall later).
    1. The command I used to enable OpenSSH is 
<strong>powershell.exe -ExecutionPolicy Bypass -File install-sshd.ps1</strong>
    2. I enabled the OpenSSH-related services in the Control Panel.
9. Disable the security features on the Windows 7 VM.
    1. Disable Data Execution Protection (DEP). You can find instructions here.
    2. I used the command <strong>bcdedit.exe /set {current} nx AlwaysOff</strong>
    3. Disable Windows Firewall in the control panel and disable firewall-related services.
    4. Disable Windows Update services.
    5. Set User Account Control to “Never Notify.”
10. Create a host-only virtual network in Virtualbox: instructions here. I assigned a static IP to the Windows 7 VM. Here are instructions for setting up the Windows 7 IP. Make sure you can SSH from your host OS to the virtual machine.

Optional:
You can create internet service simulator VM following the instructions here, and point the test VM to the internet service simulator VM. You can ignore the instructions to setup burp, because we are not interested in network artifacts in this test.


## Authors

* **Nicolas Hughes** - *Initial work* -

## License

This project is licensed under the MIT License - see the [LICENSE.md](LICENSE.md) file for details



