import evaluation_utilities as eu
from os import listdir
from os import path


def evaluate_scanners(config_file):
    eu_object = eu.EvaluationUtilities()
    config = eu_object.process_config(config_file)
    try:
        for image in listdir(config["image_path"]):
            eu_object = eu.EvaluationUtilities()
            config = eu_object.process_config(config_file)
            eu_object.set_logging(eu.EvaluationUtilities.MODULE_LOGGING | eu.EvaluationUtilities.MAIN_LOGGING)
            full_image_path = path.join(config["image_path"], image)
            eu_object.safemount_image(full_image_path)
            if eu_object.ingest_noriben_data():
                existing_files, deleted_files = eu_object.classify_files_from_noriben_csv()
                existing_reg, deleted_reg = eu_object.classify_registry_entries_from_noriben_csv()
                eu_object.process_file_list(existing_files, deleted_files)
                eu_object.process_registry_list(existing_reg, deleted_reg)
            eu_object.execute_virus_scanners()
            eu_object.unmount_image()
            eu_object.close()
    except Exception as e:
        eu_object.unmount_image()
        raise e


def main(config_file):
    evaluate_scanners(config_file)


if __name__ == '__main__':
    arguments = eu.EvaluationUtilities.parse_config_file()
    if arguments.config_file:
        main(arguments.config_file)
    else:
        main('config.txt')
